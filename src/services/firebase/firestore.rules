rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection - users can read/write their own data
    match /users/{userId} {
      // Profile document
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
      
      // Habits subcollection
      match /habits/{habitId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Habit completions subcollection
      match /completions/{completionId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Streaks subcollection
      match /streaks/{streakId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Journal entries subcollection
      match /journal_entries/{entryId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Journal subcollection (alternative naming)
      match /journal/{entryId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Nutrition meals subcollection
      match /meals/{mealId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Water tracking subcollection
      match /water/{dateId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Nutrition goals and settings
      match /nutrition/{docId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Workouts subcollection
      match /workouts/{workoutId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Workout progress subcollection
      match /workout_progress/{progressId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // XP and gamification data
      match /xp/{xpId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
      
      // Meditation sessions
      match /meditation_sessions/{sessionId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }
    
    // Community posts - readable by all authenticated users
    match /community_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
                               resource.data.userId == request.auth.uid;
      
      // Replies subcollection
      match /replies/{replyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                        request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() && 
                                 resource.data.userId == request.auth.uid;
      }
    }
    
    // Streak leaderboard - read-only for users, write via Cloud Functions
    match /streak_leaderboard/{entryId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Meditation content - read-only for users
    match /meditation_content/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins via console
    }
    
    // Nutrition recipes - read-only for users
    match /recipes/{recipeId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins via console
    }
    
    // Habit packs - read-only for users
    match /habit_packs/{packId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins via console
    }
    
    // Exercise library - read-only for users
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins via console
    }
    
    // Workout Plans
    match /workoutPlans/{planId} {
      // Users can read all authenticated plans (templates don't have userId, custom plans check userId)
      allow read: if isAuthenticated();
      // Users can create plans (must set userId to their own)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update/delete only their own plans, admins can update/delete any
      allow update, delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Workout Plan Progress
    match /workoutPlanProgress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User Exercise Records (subcollection)
    match /users/{userId}/exercise_records/{exerciseId} {
      allow read, write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

